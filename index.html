
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votação Onelife - Dota vs Minecraft</title>
    <!-- Carrega Tailwind CSS e a fonte pixelada -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- FIREBASE IMPORTS: Auth e Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais (fornecidas pelo ambiente Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug'); 
        
        // 1. INICIALIZAR FIREBASE
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.isAuthReady = false; 
        
        // 2. AUTENTICAÇÃO E ATIVAÇÃO DOS BOTÕES
        async function authenticateAndActivate() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                window.isAuthReady = true; 
                window.listenForVotes(); 
                
                // *** ATIVAÇÃO MÁGICA: Remove o 'disabled' e aplica as cores ativas ***
                document.getElementById('btn-dota').disabled = false;
                document.getElementById('btn-minecraft').disabled = false;
                
                // Restaura as cores originais após ativação
                document.getElementById('btn-dota').classList.remove('btn-pixel-disabled');
                document.getElementById('btn-minecraft').classList.remove('btn-pixel-disabled');
                document.getElementById('btn-dota').classList.add('bg-white', 'text-black', 'hover:bg-gray-300');
                document.getElementById('btn-minecraft').classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');


            } catch (error) {
                console.error("Erro na autenticação Firebase:", error);
                document.getElementById('vote-message').textContent = "Erro grave de conexão. Votação indisponível.";
            }
        }
        
        // A autenticação é iniciada IMEDIATAMENTE (de forma assíncrona)
        authenticateAndActivate();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'pixel': ['"Press Start 2P"', 'cursive'] },
                    colors: { 'custom-red': '#FF0000', }
                }
            }
        }
    </script>
    
    <style>
        /* Otimização de Layout para Mobile */
        body { 
            overflow-y: auto; 
            padding-top: 1rem; 
            padding-bottom: 1rem; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }

        /* Classe de Conteúdo Centralizado */
        .centered-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100%; 
            min-height: 100%;
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Redução do tamanho da fonte para a fase de escolha em Mobile */
        #escolhem-title { font-size: 1.5rem; }
        @media (min-width: 640px) { 
            #escolhem-title { font-size: 2rem; }
        }

        /* Estilos do Glitch (MANTIDOS) */
        .glitch-text { position: relative; color: #FF0000; }
        .glitch-text::before, .glitch-text::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .glitch-text::before { left: 1px; text-shadow: -1px 0 cyan; animation: glitch-anim 2s infinite linear alternate-reverse; }
        .glitch-text::after { left: -1px; text-shadow: 1px 0 magenta; animation: glitch-anim-2 3s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { transform: translate(1px, 0); } 100% { transform: translate(1px, 0); } }
        @keyframes glitch-anim-2 { 0% { transform: translate(0, 1px); } 100% { transform: translate(0, -1px); } }

        /* Estilo para os botões pixelados - Otimizado para Toque */
        .btn-pixel { 
            font-family: 'Press Start 2P', cursive; 
            padding: 0.8rem 1rem; 
            border: 3px solid white; 
            border-radius: 0.5rem; 
            box-shadow: 4px 4px 0px 0px rgba(255, 255, 255, 0.7); 
            cursor: pointer; 
            transition: all 0.1s; 
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            width: 100%; 
            touch-action: manipulation;
            font-size: 0.65rem; 
            position: relative; 
            z-index: 10; 
        }
        .btn-pixel:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px 0px rgba(255, 255, 255, 0.9); }
        .btn-pixel:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 4px 4px 0px 0px rgba(100, 100, 100, 0.7); }
        
        /* Estilo especial para botões desabilitados (cinza) */
        .btn-pixel-disabled { background-color: #333 !important; color: #999 !important; border-color: #555 !important; }

        /* Redução de Padding e Fonte na Área de Output */
        .output-box { background-color: #1a1a1a; border: 4px solid #FF0000; padding: 0.6rem; max-width: 90%; margin-top: 0.7rem; border-radius: 0.5rem; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }
        .btn-flash-success { background-color: #00CC00 !important; color: #000000 !important; }
        #output-text { font-size: 0.65rem; }
    </style>
</head>

<body id="app-body" class="bg-black flex items-center justify-center transition-colors duration-1000">

    <!-- Container principal (AGORA RELATIVO PARA POSICIONAR ABSOLUTOS) -->
    <div class="relative w-full h-screen">

        <!-- FASES INICIAIS (1 e 2) - Títulos absolutos e centralizados -->
        <h1 id="dota-title" class="centered-content text-4xl sm:text-6xl lg:text-7xl font-pixel uppercase tracking-widest text-white opacity-0">Dota</h1>
        <h1 id="minecraft-title" class="centered-content text-4xl sm:text-6xl lg:text-7xl font-pixel uppercase tracking-widest opacity-0 text-white">Minecraft</h1>

        <!-- 3. TELA DE VOTAÇÃO E ESCOLHA -->
        <div id="final-screen-content" class="centered-content opacity-0 transition-opacity duration-1000 w-full px-4 py-4 flex flex-col justify-center" style="z-index: 5;">
            
            <h1 id="escolhem-title" 
                class="font-pixel uppercase tracking-widest glitch-text mb-4 text-center"
                data-text="VOCÊS ESCOLHEM">
                VOCÊS ESCOLHEM
            </h1>
            
            <!-- Botões de Voto (Desabilitados inicialmente, esperando o Firebase) -->
            <div class="flex flex-col sm:flex-row gap-3 mb-3 w-full max-w-sm" style="z-index: 10;">
                <button onclick="castVote('dota')" id="btn-dota" disabled class="btn-pixel btn-pixel-disabled">
                    DOTA
                </button>
                <button onclick="castVote('minecraft')" id="btn-minecraft" disabled class="btn-pixel btn-pixel-disabled">
                    MINECRAFT
                </button>
            </div>

            <!-- Contadores de Votos em Tempo Real -->
            <div id="vote-counters" class="flex flex-col sm:flex-row gap-4 mb-3 text-center font-pixel text-white text-xs">
                <p>DOTA VOTOS: <span id="dota-count" class="text-green-400">0</span></p>
                <p>MINECRAFT VOTOS: <span id="minecraft-count" class="text-red-400">0</span></p>
            </div>

            <!-- Área de Resultados de Texto (Mensagem do Jogo) -->
            <div id="output-area" class="output-box hidden">
                <p id="output-text" class="text-white font-pixel text-center"></p>
                <button onclick="advanceToChampionshipScreen()" id="btn-advance" class="mt-3 btn-pixel bg-black text-white hover:bg-gray-800 hidden text-xs">
                    ANUNCIAR CAMPEONATO
                </button>
            </div>
            
            <p id="vote-message" class="mt-2 text-white font-pixel text-xs hidden">Voto Registado com sucesso!</p>
        </div>
        
        <!-- 4. Título do Campeonato (Quarto Canvas - Fundo Branco) -->
        <h1 id="campeonato-title" 
            class="centered-content text-2xl sm:text-4xl lg:text-5xl font-pixel uppercase tracking-widest opacity-0 text-center transition-opacity duration-1000 px-4">
            <span class="text-black">CAMPEONATO INTERNACIONAL</span> 
            <span class="text-custom-red">ONELIFE</span>
        </h1>
    </div>
    
    <script type="module">
        import { doc, onSnapshot, setDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTES DE TEMPO E TEXTO ---
        const DOTA_TEXT = "Quem esperaria que estaríamos aqui? Será o Dota o local da batalha intensa dos players da Onelife?";
        const MINECRAFT_TEXT = "Um torneio entre Players e Blocos.. uma chama por poder e vitória se acende em meio à comunidade.";

        const TRANSITION_DURATION = 1500;
        const DISPLAY_TIME = 2000;
        
        // --- ESTADO E ELEMENTOS ---
        let choiceMade = false; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const VOTES_DOC_PATH = `/artifacts/${appId}/public/data/onelife_votes/counts`;

        const elements = {
            dotaTitle: document.getElementById('dota-title'),
            minecraftTitle: document.getElementById('minecraft-title'),
            finalScreen: document.getElementById('final-screen-content'),
            appBody: document.getElementById('app-body'),
            campeonatoTitle: document.getElementById('campeonato-title'),
            dotaCountSpan: document.getElementById('dota-count'),
            minecraftCountSpan: document.getElementById('minecraft-count'),
            outputArea: document.getElementById('output-area'),
            outputText: document.getElementById('output-text'),
            btnAdvance: document.getElementById('btn-advance'),
            voteMessage: document.getElementById('vote-message'),
            btnDota: document.getElementById('btn-dota'),
            btnMinecraft: document.getElementById('btn-minecraft'),
        };
        
        // --- FIREBASE: ESCUTA DE VOTOS EM TEMPO REAL ---
        window.listenForVotes = function() {
            if (!window.db) return;
            const docRef = doc(window.db, VOTES_DOC_PATH);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    elements.dotaCountSpan.textContent = data.dota || 0;
                    elements.minecraftCountSpan.textContent = data.minecraft || 0;
                } else {
                    setDoc(docRef, { dota: 0, minecraft: 0 }).catch(console.error);
                }
            }, (error) => {
                console.error("Erro ao ouvir votos:", error);
                elements.voteMessage.textContent = "Erro na conexão de tempo real. Tente recarregar.";
            });
            elements.btnAdvance.classList.remove('hidden'); 
        };

        // --- FIREBASE: FUNÇÃO DE VOTAÇÃO (TRANSACTION) ---
        window.castVote = async function(game) {
            
            // VERIFICAÇÃO FINAL: Se o botão está ativo, isAuthReady DEVE ser true.
            if (!window.db || !window.isAuthReady) {
                elements.voteMessage.classList.remove('hidden');
                elements.voteMessage.textContent = "Erro grave de inicialização. Recarregue a página.";
                return; 
            }

            const clickedButton = game === 'dota' ? elements.btnDota : elements.btnMinecraft;
            
            // 1. FEEDBACK VISUAL IMEDIATO e DESABILITAR
            elements.btnDota.disabled = true;
            elements.btnMinecraft.disabled = true;
            clickedButton.classList.add('btn-flash-success'); 
            clickedButton.classList.remove('bg-white', 'text-black', 'bg-red-600', 'text-white'); // Remove cores ativas para o flash
            

            // 2. EXIBIR TEXTO 
            const text = game === 'dota' ? DOTA_TEXT : MINECRAFT_TEXT;
            elements.outputText.textContent = text;
            elements.outputArea.classList.remove('hidden');
            elements.voteMessage.classList.remove('hidden');
            elements.voteMessage.textContent = "A registar voto...";
            
            // 3. REGISTRAR VOTO NA BASE DE DADOS
            const docRef = doc(window.db, VOTES_DOC_PATH);
            let success = false;
            
            try {
                await runTransaction(window.db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (docSnap.exists()) {
                        let newCount = (docSnap.data()[game] || 0) + 1;
                        transaction.update(docRef, { [game]: newCount });
                    } else {
                        transaction.set(docRef, { dota: 0, minecraft: 0, [game]: 1 });
                    }
                });
                success = true;
                
            } catch (e) {
                console.error("Transação de voto falhou: ", e);
                elements.voteMessage.textContent = "ERRO ao registar voto. Tente novamente.";
            } finally {
                // 4. FINALIZAÇÃO E REATIVAÇÃO
                if(success) {
                    elements.voteMessage.textContent = "Voto Registado com sucesso!";
                }

                // Reativa os botões e volta às cores originais após um pequeno atraso
                setTimeout(() => {
                    elements.btnDota.disabled = false;
                    elements.btnMinecraft.disabled = false;
                    clickedButton.classList.remove('btn-flash-success');
                    
                    // Restaura as cores originais
                    if (game === 'dota') {
                        clickedButton.classList.add('bg-white', 'text-black', 'hover:bg-gray-300');
                    } else {
                        clickedButton.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                    }
                    
                }, 1000);
            }
        };

        // --- FUNÇÃO DE TRANSIÇÃO FINAL (ANÚNCIO DE CAMPEONATO) ---
        window.advanceToChampionshipScreen = function() {
            if (choiceMade) return;
            choiceMade = true;

            elements.finalScreen.classList.add('opacity-0'); 
            
            setTimeout(() => {
                // Mudar Fundo para Branco
                elements.appBody.classList.remove('bg-black');
                elements.appBody.classList.add('bg-white');

                // Mostrar o Título do Campeonato
                elements.campeonatoTitle.classList.remove('opacity-0');
            }, TRANSITION_DURATION);
        }

        // --- CONTROLE SEQUENCIAL DE TELAS (O MAIS RÁPIDO POSSÍVEL) ---
        function iniciarTransicao() {
            elements.dotaTitle.classList.remove('opacity-0');

            setTimeout(() => {
                elements.dotaTitle.classList.add('opacity-0'); 
                
                setTimeout(() => {
                    elements.minecraftTitle.classList.remove('opacity-0'); 
                    
                    setTimeout(() => {
                        elements.minecraftTitle.classList.add('opacity-0'); 
                        
                        setTimeout(() => {
                            // AQUI a animação acaba, e os botões serão ATIVOS ou CINZENTOS
                            elements.finalScreen.classList.remove('opacity-0'); 
                        }, TRANSITION_DURATION);
                        
                    }, DISPLAY_TIME);
                    
                }, TRANSITION_DURATION);
                
            }, DISPLAY_TIME);
        }

        // Inicia a sequência de animação imediatamente ao carregar
        window.onload = iniciarTransicao;
    </script>
</body>
</html>

